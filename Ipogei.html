<!doctype html>
<!--  https://www.maps.ie/coordinates.html -->
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>GAT A.R.</title>
        <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
        <!--<script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>-->
        <!--<script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>-->
        
        <script src="https://github.com/supermedium/superframe/blob/master/components/look-at/dist/aframe-look-at-component.min.js"></script>
        <!--
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
        -->
        <!-- Pure three.js code that the A-Frame components use for location-based AR -->
        <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>

        <!-- AR.js A-Frame components -->
        <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
        
        <style>
            .arjs-loader {
              height: 100%;
              width: 100%;
              position: absolute;
              top: 0;
              left: 0;
              z-index: 9999;
              display: flex;
              justify-content: center;
              align-items: center;
            }
            .arjs-loader div {
              text-align: center;
              font-size: 1.25em;
              color: black;
              background-color: #999;
            }
        </style>
    </head>
    <script>
        let unicID;
        const data = [{
            id: 0,
            id_text: "text-casa-santegidio",
            id_img: "casa-santegidio",
            type: "location",
            text: "CASA NATIA SANT’EGIDIO ",
            imgURL: "assets/uscita-emergenza.jpg",
            lat: 40.474332, 
            lon: 17.2343445
        },{
            id: 1,
            id_text: "text-santagostino",
            id_img: "santagostino",
            type: "location",
            text: "SANT’AGOSTINO ",
            imgURL: "assets/location.png",
            lat: 40.473931137786714, 
            lon: 17.233784821170858,
        },{
            id: 2,
            id_text: "text-PALAZZO-GALEOTA",
            id_img: "PALAZZO-GALEOTA",
            type: "location",
            text: "PALAZZO GALEOTA ",
            imgURL: "assets/location.png",
            lat: 40.4745816,
            lon: 17.2318503,
        },{
            id: 3,
            id_text: "text-PIAZZA-DUOMO",
            id_img: "PIAZZA-DUOMO",
            type: "location",
            text: "PIAZZA DUOMO ",
            imgURL: "assets/location.png",
            lat: 40.4759083,
            lon: 17.2290723,
        },{
            id: 4,
            id_text: "text-PALAZZO-ULMO",
            id_img: "PALAZZO-ULMO",
            type: "location",
            text: "PALAZZO ULMO ",
            imgURL: "assets/location.png",
            lat: 40.4767877,
            lon: 17.227282,
        },{
            id: 5,
            id_text: "text-PALAZZO-SPARTERA",
            id_img: "PALAZZO-SPARTERA",
            type: "location",
            text: "PALAZZO SPARTERA ",
            imgURL: "assets/location.png",
            lat: 40.4768893,
            lon: 17.2259746, 
        },{
            id: 6,
            id_text: "text-hotel-armeni",
            id_img: "hotel-armeni",
            type: "location",
            text: "HOTEL SAN ANDREA DEGLI ARMENI ",
            imgURL: "assets/location.png",
            lat: 40.4750046,
            lon: 17.2300906,
        },{
            id: 7,
            id_text: "text-PALAZZOSTOLA",
            id_img: "PALAZZOSTOLA",
            type: "location",
            text: "PALAZZO STOLA ",
            imgURL: "assets/alert.png",
            lat: 40.4741673,
            lon: 17.2312148,        
        },{
            id: 8,
            id_text: "text-PALAZZOantonlli",
            id_img: "PALAZZOantonelli",
            type: "location",
            text: "PALAZZO ANTONELLI ",
            imgURL: "assets/alert.png",
            lat: 40.4736595,
            lon: 17.2322077,        
        },{
            id: 9,
            id_text: "text-PALAZZOborion",
            id_img: "PALAZZOborion",
            type: "location",
            text: "PALAZZO BARION SANTAMATO ",
            imgURL: "assets/alert.png",
            lat: 40.4739412,
            lon: 17.2315159,        
        },{
            id: 100,
            id_text: "text-temenide",
            id_img: "temenide",
            type: "location",
            text: "TEST TEMENIDE ",
            imgURL: "assets/uscita-emergenza.jpg",
            lat: 40.462654,
            lon: 17.250845,
        },{
            id: 101,
            id_text: "text-piscina",
            id_img: "PISCINA",
            type: "location",
            text: "TEST PISCINA MEDITERRANEO VILLAGE",
            imgURL: "assets/uscita-emergenza.jpg",
            lat: 40.463419, 
            lon: 17.248151,
        },{
            id: 1000,
            id_text: "text-santantonio",
            id_img: "santantoio",
            type: "location",
            text: "SANT'ANTONIO ",
            imgURL: "assets/uscita-emergenza.jpg",
            lat: 40.465524, 
            lon: 17.245960
        }];     

        function returnDistance(location){// funzione 
            //let distance = location.getAttribute('distanceMsg');
            let text = location.getAttribute('name') + " @ ";
            let distance = location.components['gps-new-entity-place'].distance;
            //if (!distance) {distance = "---";} // se ancora non l'ha calcolata
            distance = distance ? Math.round(distance) + " meters" : " --- ";
            return text + distance;
        }
        window.onload = () => {
            unicID = "ID-" + Date.now() + "-" + Math.round(Math.random() * 1000);
            console.log('=>', unicID);
            document.getElementById('unicID-text').setAttribute('value', 'By Angelo Mirabelli');//unicID);
            const off_line = document.getElementById('text-camera');
            const loader = document.getElementById('loader');
            const lon_text = document.getElementById('lon-text');
            const lat_text = document.getElementById('lat-text');

            let blink = true;
            let blinkig = setInterval(() => {
                blink ? off_line.setAttribute("opacity", 0): off_line.setAttribute("opacity", 1);
                blink=!blink;                        
            }, 1000);

            let downloaded = false;
            let intervallo = false;
            const el = document.getElementById('camera');

            el.addEventListener("gps-camera-update-position", async(e) =>{
                lon_text.setAttribute("value", "lon: " + e.detail.position.longitude);
                lat_text.setAttribute("value", "lat: " + e.detail.position.latitude);
            });

            el.addEventListener("gps-camera-update-position", async(e) => {
                if(!downloaded) {
                    data.map(item =>{
                        if(item.type == "location"){
                            console.log('item :', item.id, item.text)

                            const sfondo = document.createElement("a-plane");
                            sfondo.setAttribute("id", 'sfondo'+item._id);
                            sfondo.setAttribute('color', "#FFF");
                            sfondo.object3D.scale.set(5, 1.5, 0);
                            sfondo.setAttribute('opacity', '0.5');
                            sfondo.setAttribute("look-at", "[gps-new-camera]");
                            sfondo.setAttribute('gps-new-entity-place', {
                                latitude: item.lat,
                                longitude: item.lon
                            });
                            sfondo.object3D.position.set(0, 0, -10);  
                                                        
                            const img = document.createElement("a-image");
                            img.setAttribute('gps-new-entity-place', {
                                latitude: item.lat,
                                longitude: item.lon
                            });
                            img.setAttribute("src", "assets/location.png");
                            img.setAttribute("id", item.id_img);
                            img.setAttribute("look-at", el);
                            img.object3D.scale.set(3, 2, 2);
                            img.object3D.position.set(0, 1.5, 0);
                            
                            const text = document.createElement("a-text");
                            text.setAttribute('gps-new-entity-place', {
                                latitude: item.lat,
                                longitude: item.lon
                            });

                            text.setAttribute("id", item.id_text);
                            text.setAttribute("look-at", "[gps-new-camera]");
                            text.setAttribute("align", "center");
                            text.setAttribute("value", item.text);
                            text.setAttribute("name", item.text);
                            text.object3D.scale.set(2, 2, 2);
                            text.setAttribute("font", "https://cdn.aframe.io/fonts/KelsonSans.fnt");
                            //text.setAttribute('height', 0.5)

                            sfondo.setAttribute('width', ((text.getAttribute('value').length)+12)*0.06);
                            sfondo.setAttribute("height", 0.4);
                           

                            document.querySelector("a-scene").appendChild(img);
                            document.querySelector("a-scene").appendChild(text);  
                            document.querySelector("a-scene").appendChild(sfondo);                      
                        }
                    });
                    if(!intervallo) {
                        const x = setInterval(() => {
                            let a = document.querySelector('a-scene').getChildren()
                            let b = a.filter(item => item.nodeName == "A-TEXT")
                                .map(i => {                                          
                                    i.setAttribute('value',returnDistance( i )); 
                                }
                            );
                        }, 500);                            
                        intervallo = true
                    }                
                }
                downloaded=true; 
                loader.setAttribute("style", "display: none;");                  
            });
        };	        
    </script>   
    <body style="margin: 0px; overflow: hidden;">
        <div class="arjs-loader" id="loader">
            <div>Loading data, please wait...</div>
        </div>
        <!-- con vr-mode-ui="enabled: false" abilita la funzione VR sul display -->
        <!-- videoTexure: true non abilita la cam -->
        <a-scene 
            vr-mode-ui = "enabled: false"            
            loading-screen = "enabled: false;"
            arjs="sourceType: webcam; debugUIEnabled: false; ">
                
            <a-camera id = "camera" 
                gps-new-camera = 'gpsMinDistance: 5'
                rotation-reader>                
                <a-text
                    font = "https://cdn.aframe.io/fonts/Exo2Bold.fnt"
                    position="-0.2 -0.3 -1"
                    value="Beta test!"
                    opacity=1
                    width="2"
                    color="red"
                    id="text-camera"
                ></a-text>
                <a-plane position="-0.31 -0.17 -1" opacity="0.5" width=".4" height=".14" color="#000"></a-plane>
                <a-text id="lat-text" value="lat: ---" width="1" color="#00ff00" position="-0.5 -0.13 -1"></a-text>
                <a-text id="lon-text" value="lon: ---" width="1" color="#00ff00" position="-0.5 -0.17 -1"></a-text> 
                <a-text id="unicID-text" value="" width="0.5" color="magenta" position="-0.5 -0.21 -1"></a-text>               
            </a-camera>
            <!--
            <a-text
                value="Via temenide"                    
                scale="5 5 5"
                gps-new-entity-place="latitude: 40.462654; longitude: 17.250845;"
                look-at="[gps-new-camera]"
                position="0 0 0"
                id="text-temenide"
            ></a-text>
            <a-image
                src="assets/uscita-emergenza.jpg"
                gps-new-entity-place="latitude: 40.462654; longitude: 17.250845;"
                look-at="[gps-new-camera]"
                scale="03 03 03"                        
                position="0 2 0"
                id="temenide"
            ></a-image>
            
            <!-- aggiunta -->          
        </a-scene>
    </body>
</html>
