<!doctype html>
<!--  https://www.maps.ie/coordinates.html -->
<!--<script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>-->
<!--<script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>-->

<!-- Questa estensione aggiunge il supporto per il tracciamento di caratteristiche naturali (NFT)
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
 -->
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Ipogei Taranto</title>
        <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

        <!-- Questa è l'estensione principale di A-Frame per la realtà aumentata -->
        <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
        
        <!-- Questa è l'estensione per look-at -->
        <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

        <!-- Pure three.js code that the A-Frame components use for GPS location-based AR -->
        <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
        
        <link rel="stylesheet" type="text/css" href="./index.css">
        
    </head>
    <script>
        
        let unicID;
        const data = [{
            id: 0,
            id_text: "text-casa-santegidio",
            id_img: "casa-santegidio",
            type: "location",
            text: "CASA NATIA SANT’EGIDIO ",
            imgURL: "assets/uscita-emergenza.jpg",
            lat: 40.474332, 
            lon: 17.2343445
        },{
            id: 1,
            id_text: "text-santagostino",
            id_img: "santagostino",
            type: "location",
            text: "SANT’AGOSTINO ",
            imgURL: "assets/location.png",
            lat: 40.473931137786714, 
            lon: 17.233784821170858,
        },{
            id: 2,
            id_text: "text-PALAZZO-GALEOTA",
            id_img: "PALAZZO-GALEOTA",
            type: "location",
            text: "PALAZZO GALEOTA ",
            imgURL: "assets/location.png",
            lat: 40.4745816,
            lon: 17.2318503,
        },{
            id: 3,
            id_text: "text-PIAZZA-DUOMO",
            id_img: "PIAZZA-DUOMO",
            type: "location",
            text: "PIAZZA DUOMO ",
            imgURL: "assets/location.png",
            lat: 40.4759083,
            lon: 17.2290723,
        },{
            id: 4,
            id_text: "text-PALAZZO-ULMO",
            id_img: "PALAZZO-ULMO",
            type: "location",
            text: "PALAZZO ULMO ",
            imgURL: "assets/location.png",
            lat: 40.4767877,
            lon: 17.227282,
        },{
            id: 5,
            id_text: "text-PALAZZO-SPARTERA",
            id_img: "PALAZZO-SPARTERA",
            type: "location",
            text: "PALAZZO SPARTERA ",
            imgURL: "assets/location.png",
            lat: 40.4768893,
            lon: 17.2259746, 
        },{
            id: 6,
            id_text: "text-hotel-armeni",
            id_img: "hotel-armeni",
            type: "location",
            text: "HOTEL SAN ANDREA DEGLI ARMENI ",
            imgURL: "assets/location.png",
            lat: 40.4750046,
            lon: 17.2300906,
        },{
            id: 7,
            id_text: "text-PALAZZOSTOLA",
            id_img: "PALAZZOSTOLA",
            type: "location",
            text: "PALAZZO STOLA ",
            imgURL: "assets/alert.png",
            lat: 40.4741673,
            lon: 17.2312148,        
        },{
            id: 8,
            id_text: "text-PALAZZOantonlli",
            id_img: "PALAZZOantonelli",
            type: "location",
            text: "PALAZZO ANTONELLI ",
            imgURL: "assets/alert.png",
            lat: 40.4736595,
            lon: 17.2322077,        
        },{
            id: 9,
            id_text: "text-PALAZZOborion",
            id_img: "PALAZZOborion",
            type: "location",
            text: "PALAZZO BARION SANTAMATO ",
            imgURL: "assets/alert.png",
            lat: 40.4739412,
            lon: 17.2315159,        
        },{
            id: 100,
            id_text: "text-temenide",
            id_img: "temenide",
            type: "location",
            text: "TEST TEMENIDE ",
            imgURL: "assets/uscita-emergenza.jpg",
            lat: 40.462654,
            lon: 17.250845,
        },{
            id: 101,
            id_text: "text-piscina",
            id_img: "PISCINA",
            type: "location",
            text: "TEST PISCINA MEDITERRANEO VILLAGE",
            imgURL: "assets/uscita-emergenza.jpg",
            lat: 40.463419, 
            lon: 17.248151,
        },{
            id: 1000,
            id_text: "text-santantonio",
            id_img: "santantoio",
            type: "location",
            text: "SANT'ANTONIO ",
            imgURL: "assets/uscita-emergenza.jpg",
            lat: 40.465524, 
            lon: 17.245960
        },{
            id: 1001,
            id_text: "text-box",
            id_img: "box",
            type: "location",
            text: "TEST BOX GARAGE AUTO",
            imgURL: "assets/uscita-emergenza.jpg",
            lat: 40.462378, 
            lon: 17.250763
        }];     
        //for (let x = 1; x < 250; x++) {console.log(x,1+Math.log(x*0.9)*1)}
        //return

        function returnDistance(contenitore, text_component){// funzione 
            let text = text_component.getAttribute('name') + " @ ";
            let distance = contenitore.components['gps-new-entity-place'].distance;
            distance = distance ? Math.round(distance) + " meters" : " --- ";
            //return text_component + ' @ '+ distance
            return text + distance;
        }

        function updatePanelData(el) {
            window.detailTitle.innerText = el//data[el].text;
            window.detailAddressElem.innerText = "Via le mani dal naso, 118";
            window.detailDistanceElem.innerText = window.detailDistanceElem;
            window.descriptionElem.innerText = 'Lorem Ipsum è un testo segnaposto utilizzato nel settore della tipografia e della stampa. Lorem Ipsum è considerato il testo segnaposto standard sin dal sedicesimo secolo, quando un anonimo tipografo prese una cassetta di caratteri e li assemblò per preparare un testo campione.';
            
            
                       
        }

        function closePanel() {
            console.log('close')
            // if already opened, hide panel
            window.openPanel = false;
            //window.img.src = './assets/footer-button.svg';
            window.panel.classList.remove('opened');
        }

        function apriPannello(el) {
            
            if (!window.openPanel) {
                window.openPanel = true;
                window.panel.classList.add('opened');
                window.titleElem.innerText = 'titleElem';
                window.distanceElem.innerText = 'distanceElem';
                window.moreDetailsLink.href = `https://www.bibliotecasalaborsa.it`;

                updatePanelData(el);
            } else {
                closePanel()
            }
        }

        window.onload = () => {
            //https://cartigli.chialab.io/index.js
            unicID = "ID-" + Date.now() + "-" + Math.round(Math.random() * 1000);
            console.log('=>', unicID);
            document.getElementById('unicID-text').setAttribute('value', 'By Angelo Mirabelli');//unicID);
            const off_line = document.getElementById('text-camera');
            const loader   = document.getElementById('loader');
            const lon_text = document.getElementById('lon-text');
            const lat_text = document.getElementById('lat-text');
            const button = document.querySelector('.close');
            window.panel = document.querySelector('.detail-panel');
            window.img = document.querySelector('.footer-button img');

            window.titleElem = document.querySelector('.footer-place-title');
            window.distanceElem = document.querySelector('.footer-place-distance');
            window.descriptionElem = document.querySelector('.detail-description');
            window.detailTitle = document.querySelector('.detail-title');
            window.detailDistanceElem = document.querySelector('.detail-distance');
            window.detailAddressElem = document.querySelector('.detail-address');
            window.moreDetailsLink = document.querySelector('.more-details');          

            button.addEventListener('click', () => {console.log('close');closePanel()})

            let downloaded = false;
            let intervallo = false;
            const el = document.getElementById('camera');

            el.addEventListener("gps-camera-update-position", async(e) => {
                const lon = e.detail.position.longitude.toFixed(8); // massimo 8 cifre decimali
                const lat = e.detail.position.latitude.toFixed(8);
                lon_text.setAttribute("value", "lon: " + lon);
                lat_text.setAttribute("value", "lat: " + lat);
                if(!downloaded) {
                    data.map(item =>{
                        if(item.type == "location"){
                            console.log('item :', item.id, item.text)

                            const entitaContenitore =  document.createElement("a-entity");
                            entitaContenitore.setAttribute("look-at", "[gps-new-camera]");
                            entitaContenitore.setAttribute("id", 'entity-'+item.id);
                            entitaContenitore.setAttribute('gps-new-entity-place', {
                                latitude: item.lat,
                                longitude: item.lon
                            });
                            entitaContenitore.setAttribute('cursor-listener', item.id)
                            entitaContenitore.setAttribute("descrizione", 'Lorem Ipsum è un testo segnaposto utilizzato nel settore della tipografia e della stampa. Lorem Ipsum è considerato il testo segnaposto standard sin dal sedicesimo secolo, quando un anonimo tipografo prese una cassetta di caratteri e li assemblò per preparare un testo campione. ');
                            
                            const img = document.createElement("a-image");
                            img.setAttribute("src", "assets/location.png");
                            img.setAttribute("id", 'img-'+item.id);
                            //img.object3D.scale.set(3, 2, 2);
                            img.object3D.position.set(0, 0.7, 0);
                            
                            const text = document.createElement("a-text");
                            text.setAttribute("id", 'text-'+item.id);
                            text.setAttribute("align", "center");
                            text.setAttribute("value", item.text);
                            text.setAttribute("name", item.text);
                            //text.setAttribute('cursor-listener','')
                            //text.object3D.scale.set( 2, 2, 2);
                            
                            const sfondo = document.createElement("a-plane");
                            sfondo.setAttribute("id", 'sfondo-'+item.id);
                            sfondo.setAttribute('color', "#FFF");
                            sfondo.object3D.scale.set(3, 1.5, 0);
                            sfondo.setAttribute('opacity', '0.5');
                            sfondo.object3D.position.set(0, 0, -10);                              
                            //sfondo.setAttribute('width', ((text.getAttribute('value').length)+12)*0.06);
                            sfondo.setAttribute('width', (item.text.length+12)*0.06);
                            sfondo.setAttribute("height", 0.5);  
                                             
                            entitaContenitore.appendChild(img);
                            entitaContenitore.appendChild(sfondo); 
                            entitaContenitore.appendChild(text);                     
                            document.querySelector("a-scene").appendChild(entitaContenitore);
                        }
                    });
                    if(!intervallo) { 
                        const x = setInterval(() => {                            
                            data.forEach(item => {
                                const contenitore = document.getElementById('entity-' + item.id)
                                const distance = contenitore.components['gps-new-entity-place'].distance;
                                //if (distance >800) return;

                                const text = document.getElementById('text-'+ item.id)                                
                                
                                text.setAttribute('value', returnDistance(contenitore, text )); 
                                //text.setAttribute('text', 'value:' + returnDistance(contenitore, text ));
                                const sfondo = document.getElementById('sfondo-'+item.id)                                
                                
                                //const scale = (Math.exp(distance/15)*1); // calcola la scala in base alla distanza con un maasimo di 6
                                //const scale = 0.1*distance+1;
                                let costante = 1;
                                if (distance > 135) costante = 5;
                                const scale = 1 + Math.log(distance)*costante;
                                //if (scale > 20) scale=20;
                                
                                //contenitore.setAttribute('scale', { x: scale, y: scale, z: scale });
                                contenitore.object3D.scale.set(scale, scale, scale)
                                //const widthText = AFRAME.utils.entity.getComponentProperty(text, 'text').width;
                                const widthText = ((text.getAttribute('value').length)+12)*0.06//*scale;
                                //totalWidth = data.value.length * (data.width / data.wrapCount)
                                sfondo.setAttribute('width', widthText*1); 
                            }); //~map
                        }, 2000);                            
                        intervallo = true
                    }                
                } //~ if dowloaded
                downloaded=true; 
                loader.setAttribute("style", "display: none;");                  
            });
        };
        

    </script>   
    <!--<body style="margin: 0px; overflow: hidden;">-->
    <body style="margin: 0px 0px 0px -16px; overflow: hidden; height: 480px, width: 640px;"></body>
        <div class="arjs-loader" id="loader">
            <div>Loading data, please wait...</div>
        </div>
        <!-- con vr-mode-ui="enabled: false" abilita la funzione VR sul display -->
        <!-- videoTexure: true non abilita la cam -->
        <a-scene 
            vr-mode-ui = "enabled: false"            
            loading-screen = "enabled: false;"
            arjs="sourceType: webcam; debugUIEnabled: false; "
            >    
            <a-camera id = "camera" 
                gps-new-camera = 'gpsMinDistance: 5'
                rotation-reader>                
                <a-entity
                    animation__click="property: scale; startEvents: click; easing: easeInCubic; dur: 150; from: 0.1 0.1 0.1; to: 0.7 0.7 0.7; "
                    animation__fusing="property: scale; startEvents: fusing; easing: easeInCubic; dur: 1000; from: 1 1 1; to: 0.3 0.3 0.3; "
                    animation__mouseleave="property: scale; startEvents: mouseleave; easing: easeInCubic; dur: 500; to: 1 1 1; "
                    animation__colorfusing="property: components.material.material.color; type: color; from: cyan; to: red; startEvents: fusing; dur: 500"
                    animation__colormouseleave="property: components.material.material.color; type: color; from: red; to: cyan; startEvents: mouseleave; dur: 500"
                    cursor="fuse: true;"
                    material="color: cyan; shader: flat"
                    position="0 0 -3"
                    geometry="primitive: ring; radiusInner: 0.05; radiusOuter: 0.07;">
                </a-entity>     
                <a-text
                    animation="property: components.text.material.uniforms.opacity.value; to: 0; dir: alternate; loop: true"
                    font = "https://cdn.aframe.io/fonts/Exo2Bold.fnt"
                    position="0.4 0.6 -1"
                    value="Beta test!"
                    opacity=1
                    width=".7"
                    color="red"
                    id="text-camera"
                ></a-text>
                <a-plane position="-0.31 -0.17 -1" opacity="0.5" width=".4" height=".14" color="#000"></a-plane>
                <a-text id="lat-text" value="lat: ---" width="1" color="#00ff00" position="-0.5 -0.13 -1"></a-text>
                <a-text id="lon-text" value="lon: ---" width="1" color="#00ff00" position="-0.5 -0.17 -1"></a-text> 
                <a-text id="unicID-text" value="" width="0.5" color="magenta" position="-0.5 -0.21 -1"></a-text> 
                <!--
                <a-entity id="cylinderText" value="This is a cylinder" align="center" with="0.2" color="#fff" visible="true" position="0 -0.3 -0.9"
                    geometry="primitive: plane; width: .7 height: .5; " material="color: #555; opacity: 0.8"></a-entity>              
                
                <a-entity
                    id="cylinderText" visible='false'
                    geometry="primitive: plane; width: .7; height: .5; " material="color: #999; opacity: 1"
                    text="xOffset: 0.01; font: mozillavr; baseline: top; value: This text will be 4 units wide."
                    position="0.1 -0.15 -0.9"></a-entity>
                    <a-text></a-text>-->
            </a-camera>  
            <!--<a-entity raycaster="objects: .interactive; showLine: true; lineColor: red; lineOpacity: 0.5" cursor></a-entity>     -->   
            <!--
             <a-entity look-at="[gps-new-camera]" gps-new-entity-place="latitude: 40.462388; longitude: 17.250753;">
                <a-image src="url(assets/location.png)" ></a-image>
                    <a-entity id='test' geometry="primitive: plane" material="color: white; opacity: 0.5" position="0 -2 0" width="auto" height="auto"
                    text = "color: white; align: center; value: Testo prova; width: 2;">
                </a-entity>
            </a-entity>           
             -->          
        </a-scene>
        <div class="footer">
            <div class="footer-container">
                <div class="footer-place-title">Titolo del posto</div>
                <div class="footer-place-distance">distanza</div>
            </div>
            <button class="footer-button">Go</button>
        </div>
        <div class="detail-panel">
            <button class="close">X</button>
            <button class="speak"></button> 
            <div class="detail-title"></div>
            <div class="detail-more">
                <span class="detail-address"></span>
                <span class="detail-distance"></span>
            </div>
            <div class="detail-description"></div>
            <a class="more-details"> Maggiori dettagli ...</a>
        </div>    

        <script>
            AFRAME.registerComponent('cursor-listener', {
                
                init: function () {

                    var data = this.data;
                    var el = this.el;                  

                    el.addEventListener('mouseenter', function () {
                        const scala = el.getAttribute('scale').x;
                        document.getElementById('unicID-text').setAttribute('value', 'mouse enter on' + scala);//unicID);
                    });

                    el.addEventListener('mouseleave', function () {
                        document.getElementById('unicID-text').setAttribute('value', 'mouse leave on' + data);
                        document.getElementById('cylinderText').setAttribute('visible', 'false');
                    });

                    el.addEventListener('click', function () {
                        document.getElementById('unicID-text').setAttribute('value', 'click on' + data);//unicID);
                        console.log('click', el)
                        apriPannello(data);
                        const dis = el.components['gps-new-entity-place'].distance;
                        window.detailDistanceElem = dis;
                        const lorem = el.getAttribute('descrizione')
                        document.getElementById('cylinderText').setAttribute('text', 'value: click on '+ data +'\n' + dis + '\n' + lorem);
                    });
                }
            });
        </script>
    </body>
</html>
