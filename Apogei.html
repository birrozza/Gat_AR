<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Apogei Taranto</title>
        <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
        <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
        <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
        <style>
            .arjs-loader {
              height: 100%;
              width: 100%;
              position: absolute;
              top: 0;
              left: 0;
              z-index: 9999;
              display: flex;
              justify-content: center;
              align-items: center;
            }
            .arjs-loader div {
              text-align: center;
              font-size: 1.25em;
              color: black;
              background-color: #999;
            }
        </style>
    </head>
    <body >
        <!--
        <div class="arjs-loader" id="loader">
            <div>Loading data, please wait...</div>
        </div>
        <!-- con vr-mode-ui="enabled: false" abilita la funzione VR sul display -->
        <!-- videoTexure: true non abilita la cam -->
        <a-scene vr-mode-ui='enabled: false' arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false' renderer='antialias: true; alpha: true'>
            <a-camera
                id="camera"  
                gps-new-camera = 'gpsMinDistance: 5'
                rotation-reader>   
                 <!--                            
                <a-text
                    font = "https://cdn.aframe.io/fonts/Exo2Bold.fnt"
                    position="-0.2 -0.3 -1"
                    value="Server!"
                    opacity=1
                    width="2"
                    color="red"
                    id="text-camera"
                ></a-text>
                <a-plane position="-0.21 -0.17 -1" opacity="0.5" width=".5" height=".14" color="#000"></a-plane>
                <a-text id="lat-text" value="lat:   Waiting for" width="1" color="#00ff00" position="-0.45 -0.13 -1"></a-text>
                <a-text id="lon-text" value="lon:  GPS data..." width="1" color="#00ff00" position="-0.45 -0.17 -1"></a-text> 
                <a-text id="unicID-text" value="" width="1" color="magenta" position="-0.45 -0.21 -1" ></a-text>               
                <!--<a-entity position="-0.20 -0.25 -1" testo-con-sfondo="valore: Ciao Mondo"></a-entity>-->
            </a-camera>
            <!--
            <a-image
                src="assets/location.png"
                
                
                gps-entity-place="latitude: 40.4626086; longitude: 17.250842;"
                id="test-img"
            ></a-image>
            <a-text
                value="test"
                
                
                gps-entity-place="latitude: 40.4626086; longitude: 17.250842;"
                id="text-test"
            ></a-text> 
            -->
        </a-scene>
        <script>
            const data = [
                {
                    "name": "CASA NATIA SANTâ€™EGIDIO",
                    "lon": 40.474332,
                    "lat": 17.2343445
                },
                {
                    "name": "test",
                    "lon": 40.4624531,
                    "lat": 17.2517721   
                }
            ]; 
            
            
            
            window.onload = () => {
               
                let downloaded = false;
    
                const el = document.querySelector("[gps-new-camera]");
    
                el.addEventListener("gps-camera-update-position", async(e) => {
                    if(!downloaded) {
                        
                        const west = e.detail.position.longitude - 0.05,
                            east = e.detail.position.longitude + 0.05,
                            south = e.detail.position.latitude - 0.05;
                            north = e.detail.position.latitude + 0.05;
                        console.log(`${west} ${south} ${east} ${north}`);
                        const response = await fetch(`https://hikar.org/webapp/map?bbox=${west},${south},${east},${north}&layers=poi&outProj=4326`);
                        const pois = await response.json();
                        pois.features.forEach ( feature => {
                            //alert('acquisito');
                            const compoundEntity = document.createElement("a-entity");
                            compoundEntity.setAttribute('gps-new-entity-place', {
                                latitude: feature.lat,
                                longitude: feature.lon
                            });
                            const box = document.createElement("a-box");
                            box.setAttribute("scale", {
                                x: 20,
                                y: 20,
                                z: 20
                            });
                            box.setAttribute('material', { color: 'red' } );
                            box.setAttribute("position", {
                                x : 0,
                                y : 20,
                                z: 0
                            } );
                            const text = document.createElement("a-text");
                            const textScale = 100;
                            text.setAttribute("look-at", "[gps-new-camera]");
                            text.setAttribute("scale", {
                                x: textScale,
                                y: textScale,
                                z: textScale
                            });
                            text.setAttribute("value", feature.name);
                            text.setAttribute("align", "center");
                            compoundEntity.appendChild(box);
                            compoundEntity.appendChild(text);
                            document.querySelector("a-scene").appendChild(compoundEntity);
                        });
                    }
                    downloaded = true;
                });
            };    
        </script>
    </body>
</html>    