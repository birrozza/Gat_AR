<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Apogei Taranto</title>
        <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
        <!--<script src="https://github.com/supermedium/superframe/blob/master/components/look-at/dist/aframe-look-at-component.min.js"></script>-->
        <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
        <!-- Pure three.js code that the A-Frame components use for location-based AR -->
        <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>

        <!-- AR.js A-Frame components -->
        <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
        <style>
            .arjs-loader {
              height: 100%;
              width: 100%;
              position: absolute;
              top: 0;
              left: 0;
              z-index: 9999;
              display: flex;
              justify-content: center;
              align-items: center;
            }
            .arjs-loader div {
              text-align: center;
              font-size: 1.25em;
              color: black;
              background-color: #999;
            }
        </style>
    </head>
    <script>
        const data = [
            {
                "name": "CASA NATIA SANTâ€™EGIDIO",
                "lon": 40.474332,
                "lat": 17.2343445
            },
            {
                "name": "test",
                "lon": 40.4624531,
                "lat": 17.2517721   
            }
        ]; 
        
        
        
        window.onload = () => {
            console.log('-->', data)
            let downloaded = false; 
            const el = document.querySelector("[gps-new-camera]");
            //const el = document.getElementById('camera');
            const lon_text = document.getElementById('lon-text');
            const lat_text = document.getElementById('lat-text');

            el.addEventListener("gps-camera-update-position", async(e) => {
                //if(!downloaded) {
                    
                    lon_text.setAttribute("value", "lon: " + e.detail.position.longitude);
                    lat_text.setAttribute("value", "lat: " + e.detail.position.latitude);                    
                }) // ~addEventListener       
                    data.map(item =>{
                            const compoundEntity = document.createElement("a-entity");
                            console.log('item location:',  item.name )
                            const sfondo = document.createElement("a-plane");
                            //sfondo.setAttribute("id", 'sfondo'+item._id);
                            sfondo.setAttribute('color', "#FFF");
                            sfondo.object3D.scale.set(5, 1.5, 0);
                            sfondo.setAttribute('opacity', '0.5');
                            sfondo.setAttribute("look-at", "#camera");
                            sfondo.setAttribute('gps-new-entity-place', {
                                latitude: item.lat,
                                longitude: item.lon
                            });
                            sfondo.object3D.position.set(0, 0, -10);                    

                            const img = document.createElement("a-image");
                            //img.setAttribute("id", 'img'+item._id);
                            img.setAttribute('gps-new-entity-place', {
                                latitude: item.lat,
                                longitude: item.lon
                            });
                            img.setAttribute("src", "assets/location.png");                    
                            img.setAttribute("look-at", "[gps-new-camera]");
                            img.object3D.scale.set(5, 3, 3);
                            img.object3D.position.set(0, 2.5, 0);
                            img.setAttribute('opacity','0.8')

                            const text = document.createElement("a-text");
                            //text.setAttribute("id", 'text'+item._id);
                            text.setAttribute('gps-new-entity-place', {
                                latitude: item.lat,
                                longitude: item.lon
                            });                    
                            text.setAttribute("look-at", "[gps-new-camera]");
                            text.setAttribute("align", "center");
                            text.setAttribute("value", item.name);
                            text.setAttribute("name", item.name);
                            text.object3D.scale.set(5, 5, 5);
                            text.setAttribute('color', '#fff')
                            text.setAttribute('opacity', '1')
                            
                            sfondo.setAttribute('width', ((text.getAttribute('value').length)+12)*0.12)
                            
                            compoundEntity.appendChild(img);
                            compoundEntity.appendChild(text);
                            compoundEntity.appendChild(sfondo);
                            document.querySelector("a-scene").appendChild(compoundEntity);

                            //document.querySelector("a-scene").appendChild(img);                    
                            //document.querySelector("a-scene").appendChild(text);
                            //document.querySelector("a-scene").appendChild(sfondo);                                
                        
                    }); // data.map
                //} // ~ if !downloaded
                //downloaded = true;       
           // }) // ~addEventListener
        } // ~ window.onload

    </script>
    <body style="margin: 0px; overflow: hidden;">
        <div class="arjs-loader" id="loader">
            <div>Loading data, please wait...</div>
        </div>
        <!-- con vr-mode-ui="enabled: false" abilita la funzione VR sul display -->
        <!-- videoTexure: true non abilita la cam -->
        <a-scene 
            vr-mode-ui = "enabled: false"            
            loading-screen = "enabled: false;"
            arjs="sourceType: webcam; debugUIEnabled: false; "
            >
            <a-camera
                id="camera"  
                gps-new-camera = 'gpsMinDistance: 5'
                rotation-reader>                                
                <a-text
                    font = "https://cdn.aframe.io/fonts/Exo2Bold.fnt"
                    position="-0.2 -0.3 -1"
                    value="Server!"
                    opacity=1
                    width="2"
                    color="red"
                    id="text-camera"
                ></a-text>
                <a-plane position="-0.21 -0.17 -1" opacity="0.5" width=".5" height=".14" color="#000"></a-plane>
                <a-text id="lat-text" value="lat:   Waiting for" width="1" color="#00ff00" position="-0.45 -0.13 -1"></a-text>
                <a-text id="lon-text" value="lon:  GPS data..." width="1" color="#00ff00" position="-0.45 -0.17 -1"></a-text> 
                <a-text id="unicID-text" value="" width="1" color="magenta" position="-0.45 -0.21 -1" ></a-text>               
                <!--<a-entity position="-0.20 -0.25 -1" testo-con-sfondo="valore: Ciao Mondo"></a-entity>-->
            </a-camera>
            <!--
            <a-image
                src="assets/location.png"
                
                
                gps-entity-place="latitude: 40.4626086; longitude: 17.250842;"
                id="test-img"
            ></a-image>
            <a-text
                value="test"
                
                
                gps-entity-place="latitude: 40.4626086; longitude: 17.250842;"
                id="text-test"
            ></a-text> 
            -->
        </a-scene>
    </body>
</html>    