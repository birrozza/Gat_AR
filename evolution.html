<!doctype html>
<!--  https://www.maps.ie/coordinates.html -->
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>GAT A.R.</title>
        <!--
        <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
        <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
        <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
        <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
        -->
        <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
        <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
        <style>
            .arjs-loader {
              height: 100%;
              width: 100%;
              position: absolute;
              top: 0;
              left: 0;
              z-index: 9999;
              display: flex;
              justify-content: center;
              align-items: center;
            }
            .arjs-loader div {
              text-align: center;
              font-size: 1.25em;
              color: black;
              background-color: #999;
            }
        </style>
    </head>
    <script>
            const data = [{/*
                id: 0,
                type: "location",
                text: "Via temenide",
                imgURL: "assets/location.png",
                lat: 40.462654,
                lon: 17.250845,
            },{*/
                id: 1,
                type: "location",
                text: "GAT",
                imgURL: "assets/location.png",
                lat: 40.4233336,
                lon: 17.2858356,
            },{
                id: 2,
                type: "location",
                text: "Officina",
                imgURL: "assets/location.png",
                lat: 40.4233336,
                lon: 17.2858356,
            },{
                id: 3,
                type: "location",
                text: "Casa Nonno Vito",
                imgURL: "assets/location.png",
                lat: 40.4663771,
                lon: 17.2471326,
            },{
                id: 4,
                type: "location",
                text: "Casa Nonna Antonietta",
                imgURL: "assets/location.png",
                lat: 40.46705732564022,
                lon: 17.2545455,
            },{
                id: 5,
                type: "gltf-model",
                animation: {property: "rotation", 
                            to: "0 360 0", 
                            loop: true,
                            dur: 20000, 
                            easing: "linear"},
                text: "gltf-model_1",
                imgURL: "assets/savio/test_2.gltf",
                lat: 40.46705732564022,
                lon: 17.2545455,
            },{
                id: 6,
                type: "gltf-model",
                animation: {property: "rotation", 
                            to: "0 360 0", 
                            loop: true,
                            dur: 20000, 
                            easing: "linear"},
                text: "gltf-model_2",
                imgURL: "assets/magnemite/scene.gltf",
                lat: 40.46705732564022,
                lon: 17.2545455,            
            }];     

            function returnDistance(location, text){// funzione             
                let distance = location.getAttribute('distanceMsg');
                if (!distance) distance = "---"; // se ancora non l'ha calcolata
                return text + distance;
            }
            window.onload = () => {
                const off_line = document.getElementById('text-camera');
            	const loader = document.getElementById('loader');
                const lon_text = document.getElementById('lon-text');
                const lat_text = document.getElementById('lat-text');

            	let blink = true;
		        let blinkig = setInterval(() => {
                    blink ? off_line.setAttribute("opacity", 0): off_line.setAttribute("opacity", 1);
                    blink=!blink;                        
                }, 1000);

                let downloaded = false;
                let intervallo = false;
                const el = document.getElementById('camera');

                el.addEventListener("gps-camera-update-position", async(e) =>{
                    lon_text.setAttribute("value", e.detail.position.longitude);
                    lat_text.setAttribute("value", e.detail.position.latitude);
                });

                /*el.addEventListener("gps-camera-update-position", async(e) => */{
                    if(!downloaded) {
                        /*const west = e.detail.position.longitude - 0.05,
                            east = e.detail.position.longitude + 0.05,
                            south = e.detail.position.latitude - 0.05,
                            north = e.detail.position.latitude + 0.05;
                        console.log(`${west} ${south} ${east} ${north}`);*/
                        data.map(item =>{
                            if(item.type == "location"){
                                console.log('item :', item.id)
                                /*const compoundEntity = document.createElement("a-entity");
                                compoundEntity.setAttribute('gps-new-entity-place', {
                                    latitude: item.lat,
                                    longitude: item.lon
                                });*/
                                
                                const img = document.createElement("a-image");
                                img.setAttribute('gps-entity-place', {
                                    latitude: item.lat,
                                    longitude: item.lon
                                });
                                img.setAttribute("src", item.imgURL);
                                img.setAttribute("scale", "3 3 3");
                                img.setAttribute("position", {
                                    x : 0,
                                    y : 2,
                                    z : 0
                                } );
                                const text = document.createElement("a-text");
                                text.setAttribute('gps-entity-place', {
                                    latitude: item.lat,
                                    longitude: item.lon
                                });                                
                                text.setAttribute("id", item.id);
                                text.setAttribute("look-at", "[gps-camera]");
                                text.setAttribute("align", "center");
                                text.setAttribute("value", item.text);
                                /*text.setAttribute('gps-entity-place', {
                                    latitude: item.lat,
                                    longitude: item.lon
                                });*/
                                text.setAttribute("scale", "10 10 10");
                                //compoundEntity.appendChild(img);
                                //compoundEntity.appendChild(text);
                                //document.querySelector("a-scene").appendChild(compoundEntity);
                                document.querySelector("a-scene").appendChild(img);
                                document.querySelector("a-scene").appendChild(text);

                                /*const distanza = item.text + compoundEntity['gps-new-entity-place'].distance;
                                text.setAttribute("value", distanza);*/
                                
                            }
                        });
                        if(!intervallo) {const x = setInterval(()=> document.getElementById('text-camera').setAttribute('value',returnDistance( document.getElementById('text-temenide'),"prova")),100); intervallo = true}
                
                    }
                    downloaded=true; 
                    loader.setAttribute("style", "display: none;");                  
                }//);
            };
	        
    </script>   
    <body style="margin: 0px; overflow: hidden;">
        <div class="arjs-loader" id="loader">
            <div>Loading, please wait...</div>
        </div>
        <!-- con vr-mode-ui="enabled: false" abilita la funzione VR sul display -->
        <a-scene 
            vr-mode-ui="enabled: false" 
            
            loading-screen="enabled: false;"
            arjs="sourceType: webcam; debugUIEnabled: false; ">
                
            <a-camera gps-camera='gpsMinDistance: 5' rotation-reader id="camera">                
                <a-text
                    position="-0.2 -0.3 -1"
                    value="Evolution!"
                    opacity=1
                    width="1"
                    color="red"
                    id="text-camera"
                ></a-text>
                <a-text id="lon-text" value="lon: ---" width="1" color="green" position="-0.2 -0.2 -1"></a-text>
                <a-text id="lat-text" value="lat: ---" width="1" color="green" position="-0.2 -0.1 -1"></a-text>
            </a-camera>
            
            <a-text
                value="Via temenide"                    
                scale="5 5 5"
                gps-new-entity-place="latitude: 40.462654; longitude: 17.250845;"
                look-at="[gps-camera]"
                position="0 0 0"
                id="text-temenide"
            ></a-text>
            <a-image
                src="assets/uscita-emergenza.jpg"
                gps-new-entity-place="latitude: 40.462654; longitude: 17.250845;"
                look-at="[gps-camera]"
                scale="03 03 03"                        
                position="0 0 0.5"
                id="temenide"
            ></a-image>
            <!-- aggiunta -->          
        </a-scene>
    </body>
</html>
